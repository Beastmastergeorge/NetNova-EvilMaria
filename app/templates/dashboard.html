<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NetNova + EVIL MARIA</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header>
      <div>
        <h1>NetNova ISP Billing</h1>
        <h2>EVIL MARIA Monitoring & Notification Console</h2>
      </div>
      <a class="api-link" href="/docs" target="_blank" rel="noreferrer">API Docs</a>
    </header>

    <section class="stats">
      <article><h3>Customers</h3><p>{{ stats.customer_count }}</p></article>
      <article><h3>Monthly Recurring Revenue</h3><p>${{ '%.2f'|format(stats.mrr) }}</p></article>
      <article><h3>Unpaid Balance</h3><p>${{ '%.2f'|format(stats.unpaid) }}</p></article>
      <article class="critical"><h3>Critical Alerts</h3><p id="critical-count">{{ stats.critical_count }}</p></article>
    </section>

    <main>
      <section>
        <h3>Add Customer</h3>
        <form method="post" action="/customers" class="form-grid">
          <input name="name" placeholder="Customer Name" required />
          <input name="plan_name" placeholder="Plan Name" required />
          <input type="number" step="0.01" name="monthly_rate" placeholder="Monthly Rate" required />
          <input type="number" min="1" max="31" name="due_day" placeholder="Due Day" required />
          <input type="email" name="email" placeholder="Email" required />
          <button type="submit">Create Customer</button>
        </form>
      </section>

      <section>
        <h3>Create Invoice</h3>
        <form method="post" action="/invoices" class="form-grid">
          <select name="customer_id" required>
            <option value="">Choose customer</option>
            {% for customer in customers %}
            <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.plan_name }})</option>
            {% endfor %}
          </select>
          <input name="billing_month" placeholder="YYYY-MM" required />
          <input type="number" step="0.01" name="amount" placeholder="Amount" required />
          <button type="submit">Generate Invoice</button>
        </form>
      </section>

      <section>
        <h3>Log EVIL MARIA Event</h3>
        <form method="post" action="/events" class="form-grid">
          <input name="service_name" placeholder="Service / Node" required />
          <select name="severity" required>
            <option value="info">Info</option>
            <option value="warning">Warning</option>
            <option value="critical">Critical</option>
          </select>
          <input name="message" placeholder="Notification message" required />
          <button type="submit">Push Alert</button>
        </form>
      </section>

      <section>
        <h3>Invoices</h3>
        <table>
          <thead>
            <tr><th>ID</th><th>Customer ID</th><th>Month</th><th>Amount</th><th>Status</th><th>Action</th></tr>
          </thead>
          <tbody>
            {% for invoice in invoices %}
            <tr>
              <td>{{ invoice.id }}</td>
              <td>{{ invoice.customer_id }}</td>
              <td>{{ invoice.billing_month }}</td>
              <td>${{ '%.2f'|format(invoice.amount) }}</td>
              <td>{{ invoice.status }}</td>
              <td>
                {% if invoice.status != 'paid' %}
                <form method="post" action="/invoices/{{ invoice.id }}/mark-paid"><button type="submit">Mark paid</button></form>
                {% else %}â€”{% endif %}
              </td>
            </tr>
            {% else %}<tr><td colspan="6">No invoices yet.</td></tr>{% endfor %}
          </tbody>
        </table>
      </section>

      <section>
        <h3>EVIL MARIA Alerts</h3>
        <button type="button" id="toggle-speech">Enable speech notifications</button>
        <ul id="alerts-list">
          {% for event in events %}
          <li class="severity-{{ event.severity }} {% if event.acknowledged %}acknowledged{% endif %}" data-id="{{ event.id }}" data-severity="{{ event.severity }}" data-message="{{ event.message }}">
            <strong>[{{ event.severity|upper }}]</strong> {{ event.service_name }}: {{ event.message }}
            {% if not event.acknowledged %}
            <form method="post" action="/events/{{ event.id }}/ack" class="inline-form"><button type="submit">Acknowledge</button></form>
            {% else %}<em> acknowledged</em>{% endif %}
          </li>
          {% else %}<li>No monitoring events logged.</li>{% endfor %}
        </ul>
      </section>
    </main>
    <script src="/static/app.js"></script>
  </body>
</html>
